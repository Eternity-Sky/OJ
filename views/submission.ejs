<%- include('layout') %>

<div class="card">
    <div class="card-header">
        <h3>提交详情</h3>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="me-3">题目：<a href="/problems/<%= submission.problem._id %>"><%= submission.problem.title %></a></span>
                <span class="me-3">用户：<%= submission.user.username %></span>
                <span>提交时间：<%= moment(submission.submittedAt).format('YYYY-MM-DD HH:mm:ss') %></span>
            </div>
            <span class="badge bg-<%= submission.status === 'Accepted' ? 'success' : 
                (submission.status === 'Wrong Answer' ? 'danger' : 
                (submission.status === 'Pending' ? 'secondary' : 'warning')) %>">
                <%= submission.status %>
            </span>
        </div>
    </div>
    <div class="card-body">
        <% if (submission.status !== 'Pending') { %>
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>执行结果</h5>
                    <ul class="list-unstyled">
                        <li>执行时间：<%= submission.executionTime %> ms</li>
                        <li>内存使用：<%= submission.memoryUsed %> KB</li>
                        <li>测试用例：通过 <%= submission.testCasesPassed %> / <%= submission.totalTestCases %></li>
                    </ul>
                </div>
                <% if (submission.errorMessage) { %>
                    <div class="col-md-6">
                        <h5>错误信息</h5>
                        <pre class="bg-light p-2"><%= submission.errorMessage %></pre>
                    </div>
                <% } %>
            </div>
        <% } else { %>
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">正在评测中...</p>
            </div>
        <% } %>

        <h5>提交的代码</h5>
        <textarea id="code" style="display: none;"><%= submission.code %></textarea>
    </div>
</div>

<script>
    // 初始化代码编辑器（只读模式）
    var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        lineNumbers: true,
        mode: '<%= submission.language === "54" ? "text/x-c++src" : 
               (submission.language === "71" ? "python" : "text/x-java") %>',
        theme: 'default',
        readOnly: true
    });

    // 如果状态是 Pending，定期检查结果
    <% if (submission.status === 'Pending') { %>
        function checkStatus() {
            fetch('/submissions/<%= submission._id %>')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'Pending') {
                        window.location.reload();
                    }
                });
        }
        setInterval(checkStatus, 2000);
    <% } %>
</script>
